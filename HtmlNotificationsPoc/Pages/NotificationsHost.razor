@using HtmlNotificationsPoc.SignalR
@using Majorsoft.Blazor.Components.Notifications
@using Microsoft.AspNetCore.SignalR.Client  

@inject IHtmlNotificationService _notificationService
@inject NavigationManager _navigationManager  

@code {
    private HubConnection _hubConnection;

    protected override async Task OnInitializedAsync()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(_navigationManager.ToAbsoluteUri("/notifications"))
            .Build();

        _hubConnection.On("Notify", async (NotificationPayload payload) => 
        {
            if (payload != null)
            {
                if (await _notificationService.CheckPermissionAsync() == HtmlNotificationPermissionTypes.Granted)
                {
                    await _notificationService.ShowsAsync(new HtmlNotificationOptions(payload.Title)
                        {
                            Body = payload.Body
                        });
                }
            }
        });

        await _hubConnection.StartAsync();
    }
}
